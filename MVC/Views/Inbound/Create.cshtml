@model MVC.ViewModels.Inbound.InboundCreateVM
@{
    ViewData["Title"] = "Create Inbound";
}
<div class="container-fluid mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h5 mb-0">Create Inbound</h2>
        <div>
            <a class="btn btn-secondary" asp-action="Index">Back</a>
        </div>
    </div>

    <form asp-action="Create" method="post" id="inboundForm" data-ajax-url="@Url.Action("CreateAjax", "Inbound")">
        @Html.AntiForgeryToken()
        <div class="row g-3 mb-3">
            <div class="col-12 col-md-6">
                <label asp-for="ClientId" class="form-label">Client</label>
                <select asp-for="ClientId" class="form-select" asp-items="Model.Clients">
                    <option value="">-- Select Client --</option>
                </select>
                <span asp-validation-for="ClientId" class="text-danger"></span>
            </div>
            <div class="col-12 col-md-6 d-flex align-items-end justify-content-md-end">
                <div class="d-grid d-md-flex gap-2">
                    <button type="button" class="btn btn-outline-primary" id="addLine">Add Line</button>
                    <button type="submit" class="btn btn-primary">Save Inbound</button>
                </div>
            </div>
        </div>

        <h5 class="mt-3 mb-2">Lines</h5>

        <div class="card mb-3">
            <div class="card-body p-2 p-sm-3">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-0" id="linesTable">
                        <thead class="table-light">
                            <tr>
                                <th class="w-45">Product</th>
                                <th class="w-25 d-none d-sm-table-cell">Section</th>
                                <th class="w-10">Cartons</th>
                                <th class="w-10">Pallets</th>
                                <th class="w-10">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.Details.Count; i++)
                            {
                                <tr>
                                    <td>
                                        <select name="Details[@i].ProductId" class="form-select">
                                            <option value="">-- Select Product --</option>
                                            @foreach (var p in Model.Products)
                                            {
                                                if (p.Value == Model.Details[i].ProductId.ToString())
                                                {
                                                    <option selected value="@p.Value">@p.Text</option>
                                                }
                                                else
                                                {
                                                    <option value="@p.Value">@p.Text</option>
                                                }
                                            }
                                        </select>
                                        <span class="text-danger" data-valmsg-for="Details[@i].ProductId" data-valmsg-replace="true"></span>
                                    </td>
                                    <td class="d-none d-sm-table-cell">
                                        <select name="Details[@i].SectionId" class="form-select">
                                            <option value="">-- Select Section --</option>
                                            @foreach (var s in Model.Sections)
                                            {
                                                if (s.Value == Model.Details[i].SectionId.ToString())
                                                {
                                                    <option selected value="@s.Value">@s.Text</option>
                                                }
                                                else
                                                {
                                                    <option value="@s.Value">@s.Text</option>
                                                }
                                            }
                                        </select>
                                        <span class="text-danger" data-valmsg-for="Details[@i].SectionId" data-valmsg-replace="true"></span>
                                    </td>
                                    <td>
                                        <input type="number" name="Details[@i].Cartons" class="form-control" value="@Model.Details[i].Cartons" min="0" />
                                    </td>
                                    <td>
                                        <input type="number" name="Details[@i].Pallets" class="form-control" value="@Model.Details[i].Pallets" min="0" />
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-danger remove-line">Remove</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <strong>Totals:</strong> Cartons: <span id="totalCartons">@Model.TotalCartons</span> &nbsp; Pallets: <span id="totalPallets">@Model.TotalPallets</span>
            </div>
            <div class="d-none d-sm-block">
                <button type="submit" class="btn btn-primary">Save Inbound</button>
            </div>
        </div>

        <div class="d-block d-sm-none mt-3">
            <button type="submit" class="btn btn-primary w-100">Save Inbound</button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        (function(){
            const products = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Products.Select(p => new { value = p.Value, text = p.Text })));
            const sections = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Sections.Select(s => new { value = s.Value, text = s.Text })));

            function recalcTotals(){
                let cartons = 0; let pallets = 0;
                document.querySelectorAll('#linesTable tbody tr').forEach(row => {
                    const c = parseInt(row.querySelector('input[name$=".Cartons"]').value || '0');
                    const p = parseInt(row.querySelector('input[name$=".Pallets"]').value || '0');
                    cartons += isNaN(c) ? 0 : c;
                    pallets += isNaN(p) ? 0 : p;
                });
                document.getElementById('totalCartons').innerText = cartons;
                document.getElementById('totalPallets').innerText = pallets;
            }

            document.getElementById('addLine').addEventListener('click', function(){
                const tbody = document.querySelector('#linesTable tbody');
                const index = tbody.children.length;
                const tr = document.createElement('tr');
                tr.innerHTML = `\
                    <td>\
                        <select name="Details[${index}].ProductId" class="form-select">\
                            <option value="">-- Select Product --</option>\
                            ${products.map(p => `<option value="${p.value}">${p.text}</option>`).join('')}\
                        </select>\
                    </td>\
                    <td class="d-none d-sm-table-cell">\
                        <select name="Details[${index}].SectionId" class="form-select">\
                            <option value="">-- Select Section --</option>\
                            ${sections.map(s => `<option value="${s.value}">${s.text}</option>`).join('')}\
                        </select>\
                    </td>\
                    <td><input type="number" name="Details[${index}].Cartons" class="form-control" value="0" min="0" /></td>\
                    <td><input type="number" name="Details[${index}].Pallets" class="form-control" value="0" min="0" /></td>\
                    <td class="text-center"><button type="button" class="btn btn-sm btn-danger remove-line">Remove</button></td>\
                `;
                tbody.appendChild(tr);
                attachRowEvents(tr);
                recalcTotals();
            });

            function attachRowEvents(tr){
                tr.querySelectorAll('input[type=number]').forEach(inp => inp.addEventListener('input', recalcTotals));
                const btn = tr.querySelector('.remove-line');
                if (btn) btn.addEventListener('click', function(){
                    tr.remove();
                    // reindex names
                    document.querySelectorAll('#linesTable tbody tr').forEach((r,i) => {
                        r.querySelectorAll('select, input').forEach(el => {
                            const name = el.getAttribute('name');
                            const newName = name.replace(/Details\[\d+\]/, `Details[${i}]`);
                            el.setAttribute('name', newName);
                        });
                    });
                    recalcTotals();
                });
            }

            document.querySelectorAll('#linesTable tbody tr').forEach(tr => attachRowEvents(tr));
            document.querySelectorAll('#linesTable tbody tr input').forEach(inp => inp.addEventListener('input', recalcTotals));
            recalcTotals();
        })();
    </script>
}